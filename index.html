<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Evento BCC - Realtime</title>
<style>
:root{--bcc-blue:#004f71;--bcc-blue-2:#0a6b93;--bcc-green:#009739;--bcc-gold:#C9A227;--danger:#b22222;--bg1:#e0f4ff;--bg2:#f2f2f2;--bg3:#e8f5e9;}
body{font-family:Arial,sans-serif;background:radial-gradient(circle at top,var(--bg1),var(--bg2) 55%,var(--bg3));display:flex;justify-content:center;padding-top:40px;}
.container{background:#fff;padding:30px;border-radius:20px;border:4px solid var(--bcc-gold);box-shadow:0 0 25px rgba(201,162,39,.55);width:520px;max-width:95vw;}
.logo{display:block;max-width:260px;margin:0 auto 12px;}
h1{text-align:center;color:var(--bcc-blue);margin-bottom:18px;font-size:20px;}
.field{margin-bottom:14px;}label{font-weight:600;margin-bottom:4px;display:block;}
input[type=text]{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;}
#assignBtn{width:100%;padding:12px;border:none;border-radius:999px;background:linear-gradient(90deg,var(--bcc-green),var(--bcc-blue-2));color:#fff;font-weight:700;cursor:pointer;}
#assignBtn:disabled{opacity:.6;cursor:default;}
.result{margin-top:18px;text-align:center;font-size:18px;color:var(--bcc-blue);}
.result .welcome{font-size:18px;display:block;}
.result .table-label{margin-top:4px;display:block;}
.result .motto{margin-top:10px;font-size:13px;color:#2b2b2b;opacity:.92;font-style:italic;}
.result .table-number{font-size:44px;background:linear-gradient(120deg,var(--bcc-green),var(--bcc-blue-2));color:#fff;padding:10px 22px;border-radius:999px;display:inline-block;margin-top:6px;position:relative;z-index:2;min-width:88px;}
.result .table-number::before{content:"";position:absolute;top:-12px;left:-12px;right:-12px;bottom:-12px;background:radial-gradient(circle,rgba(201,162,39,.55),rgba(201,162,39,0));border-radius:50%;filter:blur(12px);animation:glowPulse 2.4s infinite ease-in-out;z-index:-1;}
@keyframes glowPulse{0%{opacity:.35;transform:scale(.92)}50%{opacity:1;transform:scale(1.15)}100%{opacity:.35;transform:scale(.92)}}
#snow-container{position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:999;}
.snowflake{position:absolute;font-size:38px;color:var(--bcc-gold);text-shadow:0 0 12px var(--bcc-gold),0 0 26px var(--bcc-gold),0 0 40px rgba(201,162,39,.9),0 0 55px rgba(201,162,39,.9);animation:snowFall 10s linear forwards;opacity:.98;}
@keyframes snowFall{0%{transform:translateY(-150px) rotate(0) scale(1);opacity:1}100%{transform:translateY(130vh) rotate(360deg) scale(1.6);opacity:0}}
.dashboard{margin-top:28px;padding-top:18px;border-top:2px dashed var(--bcc-gold);display:none;}
.dashboard-banner{background:linear-gradient(90deg,var(--bcc-green),var(--bcc-blue));background-size:200% 100%;border-radius:14px;padding:12px 16px;color:#fff;display:flex;flex-direction:column;gap:4px;margin-bottom:10px;animation:xmasGlow 8s ease-in-out infinite;}
@keyframes xmasGlow{0%{box-shadow:0 0 6px rgba(201,162,39,.35);background-position:0% 0}50%{box-shadow:0 0 18px rgba(201,162,39,.85);background-position:100% 0}100%{box-shadow:0 0 6px rgba(201,162,39,.35);background-position:0% 0}}
.dashboard-banner-title{font-weight:700;font-size:16px;}
.dashboard-banner-sub{font-size:13px;opacity:.95;}
.dashboard-banner-quote{font-size:12px;font-style:italic;opacity:.9;margin-top:4px;}
.dashboard-banner-quote span{font-style:normal;font-size:11px;opacity:.9;}
.dashboard-header{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px;}
.dashboard h2{font-size:20px;margin:0;color:var(--bcc-blue);}
.btn-pill{padding:6px 10px;font-size:12px;border-radius:999px;border:none;cursor:pointer;color:#fff;background:var(--bcc-blue);}
.btn-pill.secondary{background:var(--danger);}
.btn-pill.gold{background:var(--bcc-gold);color:#1b1b1b;}
.btn-pill:disabled{opacity:.55;cursor:default;}
.dashboard-summary{font-size:14px;margin:10px 0;}
.dashboard-summary span{font-weight:700;}
.progress-wrap{margin:10px 0 14px;}
.progress-top{display:flex;justify-content:space-between;font-size:12px;color:#333;margin-bottom:6px;}
.progress-bar{width:100%;height:10px;border-radius:999px;background:#eee;overflow:hidden;}
.progress-fill{height:100%;width:0%;background:linear-gradient(90deg,var(--bcc-green),var(--bcc-blue-2));transition:width .25s ease;}
.tables-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;}
.table-card{border:1px solid #ddd;border-radius:12px;padding:10px 10px 8px;font-size:14px;background:#fafafa;position:relative;overflow:hidden;}
.table-card::before{content:"";position:absolute;top:0;left:0;right:0;height:4px;background:repeating-linear-gradient(90deg,var(--bcc-gold) 0 8px,#ff0000 8px 16px,#00b300 16px 24px);opacity:.75;}
.table-title{font-weight:700;margin:6px 0 4px;color:var(--bcc-blue);}
.table-info{margin-bottom:6px;}
.mini-progress{width:100%;height:8px;border-radius:999px;background:#eee;overflow:hidden;margin-bottom:6px;}
.mini-progress>div{height:100%;width:0%;background:linear-gradient(90deg,var(--bcc-green),var(--bcc-blue-2));transition:width .25s ease;}
.table-card.nearly-full{border-color:#e39a2b;box-shadow:0 0 0 2px rgba(227,154,43,.15);}
.table-card.full{border-color:var(--danger);box-shadow:0 0 0 2px rgba(178,34,34,.15);}
.table-card.flash-full{animation:flashFull 1.2s ease-in-out 0s 2;}
@keyframes flashFull{0%,100%{transform:scale(1)}50%{transform:scale(1.02)}}
.people-list{margin:6px 0 8px;padding-left:0;list-style:none;font-size:12px;max-height:92px;overflow:auto;}
.people-list li{margin-bottom:4px;padding:4px 6px;border-radius:8px;border:1px solid rgba(0,0,0,.06);background:#fff;}
.people-empty{font-size:12px;color:#777;margin:6px 0 10px;}
.people-list li.tag-intollerante{background:#c62828;color:#fff;border-color:rgba(255,255,255,.2);}
.people-list li.tag-vegetariano{background:#ffeb3b;color:#111;border-color:rgba(0,0,0,.1);}
.minus-btn{width:100%;padding:6px 8px;border-radius:999px;border:none;cursor:pointer;font-size:12px;background:#f44336;color:#fff;}
.minus-btn:disabled{opacity:.45;cursor:default;}
.admin-btn{position:fixed;right:10px;bottom:10px;padding:6px 10px;font-size:11px;border-radius:999px;border:none;background:var(--danger);color:#fff;opacity:.7;z-index:1000;}
.admin-panel{margin-top:10px;display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.admin-box{border:1px solid #e5e5e5;border-radius:12px;padding:10px;background:#fff;}
.admin-box h3{margin:0 0 8px;font-size:13px;color:var(--bcc-blue);}
.last5{font-size:12px;margin:0;padding-left:16px;}
.last5 li{margin-bottom:4px;}
</style>
</head>
<body>
<div id="snow-container"></div>
<div class="container">
  <img src="logo.jpg" class="logo" alt="Logo BCC Magna Grecia" />
  <h1>Benvenuto all'evento BCC Magna Grecia</h1>

  <div id="bookingSection">
    <div id="result" class="result"></div>
    <div class="field"><label>Nome</label><input id="nameInput" type="text" /></div>
    <div class="field"><label>Ufficio / Filiale</label><input id="officeInput" type="text" /></div>
    <button id="assignBtn">Scopri il tuo tavolo</button>
  </div>

  <audio id="bellSound" src="campane.mp3" preload="auto"></audio>

  <div class="dashboard" id="dashboard">
    <div class="dashboard-banner">
      <div class="dashboard-banner-title">Cena Aziendale – Insieme… a Natale</div>
      <div class="dashboard-banner-sub">L'unione è la nostra forza: ogni posto a tavola è un posto per condividere, crescere e sentirci parte della stessa famiglia.</div>
      <div class="dashboard-banner-quote">“Da soli possiamo fare così poco; insieme possiamo fare così tanto.” <span>– Helen Keller</span></div>
    </div>

    <div class="dashboard-header">
      <h2>Dashboard tavoli</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="fullscreenBtn" class="btn-pill gold">Full screen</button>
        <button id="freezeBtn" class="btn-pill">Congela: OFF</button>
        <button id="resetBtn" class="btn-pill secondary">Azzera tavoli</button>
      </div>
    </div>

    <div class="dashboard-summary">
      Posti totali: <span id="totalSeats"></span> — Occupati: <span id="occupiedSeats"></span> — Liberi: <span id="freeSeats"></span>
    </div>

    <div class="progress-wrap">
      <div class="progress-top"><div>Progresso evento</div><div><span id="progressPct">0</span>%</div></div>
      <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
    </div>

    <div class="admin-panel">
      <div class="admin-box"><h3>Ultimi 5 assegnati</h3><ol id="last5List" class="last5"></ol></div></div>

    <div id="tablesGrid" class="tables-grid" style="margin-top:10px;"></div>
  </div>
</div>

<button id="showAdminBtn" class="admin-btn">Area organizzatori</button>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={apiKey:"AIzaSyA1EWKdl7TXVXNJpxAR5Uj1e5h5vPgxtFk",authDomain:"evento-bcc-magna-grecia.firebaseapp.com",projectId:"evento-bcc-magna-grecia",storageBucket:"evento-bcc-magna-grecia.firebasestorage.app",messagingSenderId:"767111568452",appId:"1:767111568452:web:aa7cfd66ae1995c5273011"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

const TABLE_COUNT=22;
const TABLE_CAPACITY_MAP=Object.fromEntries(Array.from({length:TABLE_COUNT},(_,i)=>{const id=i+1;const cap=(id>=20)?9:8;return [id,cap];}));
const TOTAL_SEATS=Object.values(TABLE_CAPACITY_MAP).reduce((a,b)=>a+b,0);

function normalizeNameTokens(s){return (s||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z\s]/g," ").split(/\s+/).filter(Boolean).sort().join(" ");}
const dietaryRaw=[["Antonella Mondillo","Intollerante"],["Feo Fabrizio","Intollerante"],["Giovanna Sansone","Intollerante"],["Giuseppe Caggiano","Intollerante"],["Giuseppe Cupolo","Intollerante"],["Maria Corso","Intollerante"],["Monica Oriente","Intollerante"],["Propato Mario Domenico","Intollerante"],["Rosalia La Palomenta","Intollerante"],["Valeria Guercio","Intollerante"],["Vincenzo De Stefano","Intollerante"],["Marilena Longo","Vegetariana"],["Teresa Comite","Vegetariana"]];
const dietaryMap=new Map(dietaryRaw.map(([n,t])=>[normalizeNameTokens(n),t]));
function dietaryTagFor(name){return dietaryMap.get(normalizeNameTokens(name))||null;}

let tables=[];let lastAssignedTable=null;let assignmentsFrozen=false;let prevFullSet=new Set();

const result=document.getElementById("result");
const nameInput=document.getElementById("nameInput");
const officeInput=document.getElementById("officeInput");
const bellSound=document.getElementById("bellSound");
const snowContainer=document.getElementById("snow-container");
const bookingSection=document.getElementById("bookingSection");
const totalSeatsEl=document.getElementById("totalSeats");
const occupiedSeatsEl=document.getElementById("occupiedSeats");
const freeSeatsEl=document.getElementById("freeSeats");
const tablesGrid=document.getElementById("tablesGrid");
const resetBtn=document.getElementById("resetBtn");
const dashboardEl=document.getElementById("dashboard");
const assignBtn=document.getElementById("assignBtn");
const fullscreenBtn=document.getElementById("fullscreenBtn");
const freezeBtn=document.getElementById("freezeBtn");
const progressPct=document.getElementById("progressPct");
const progressFill=document.getElementById("progressFill");
const last5List=document.getElementById("last5List");
totalSeatsEl.textContent=TOTAL_SEATS;

function playBell(){try{bellSound.volume=1;bellSound.currentTime=0;bellSound.play();}catch(e){}}
function launchSnow(){for(let i=0;i<60;i++){const s=document.createElement("div");s.classList.add("snowflake");s.textContent="✧";s.style.left=Math.random()*100+"vw";s.style.animationDelay=(Math.random()*2.5)+"s";s.style.fontSize=(32+Math.random()*18)+"px";snowContainer.appendChild(s);setTimeout(()=>s.remove(),11000);}}
function setFreezeUI(){freezeBtn.textContent=assignmentsFrozen?"Congela: ON":"Congela: OFF";freezeBtn.style.background=assignmentsFrozen?"#6d6d6d":"var(--bcc-blue)";}

function rebuildTablesFromSnapshot(snapshot){
  tables=Array.from({length:TABLE_COUNT},(_,i)=>({id:i+1,capacity:TABLE_CAPACITY_MAP[i+1],bookings:[]}));
  snapshot.forEach(doc=>{const data=doc.data();const tableId=data.table;if(typeof tableId==="number"&&tableId>=1&&tableId<=TABLE_COUNT){tables[tableId-1].bookings.push({id:doc.id,name:data.name||"",office:data.office||"",createdAt:data.createdAt||null});}});
  if(snapshot.docs.length>0){const lastDoc=snapshot.docs[snapshot.docs.length-1];const lastData=lastDoc.data();if(lastData&&typeof lastData.table==="number"){lastAssignedTable=lastData.table;}}else{lastAssignedTable=null;}
  const lastDocs=snapshot.docs.slice(-5);last5List.innerHTML="";lastDocs.forEach(d=>{const x=d.data();const li=document.createElement("li");li.textContent=`${x.name||"?"} → Tavolo ${x.table||"?"}`;last5List.appendChild(li);});
}
function allFull(){return tables.every(t=>t.bookings.length>=t.capacity);}

function renderDashboard(){
  const occupied=tables.reduce((sum,t)=>sum+t.bookings.length,0);
  const free=TOTAL_SEATS-occupied;
  totalSeatsEl.textContent=TOTAL_SEATS;occupiedSeatsEl.textContent=occupied;freeSeatsEl.textContent=free;
  const pct=TOTAL_SEATS===0?0:Math.round((occupied/TOTAL_SEATS)*100);progressPct.textContent=pct;progressFill.style.width=pct+"%";
  tablesGrid.innerHTML="";
  const nowFullSet=new Set(tables.filter(t=>t.bookings.length>=t.capacity).map(t=>t.id));
  tables.forEach(t=>{
    const used=t.bookings.length,cap=t.capacity,perc=cap===0?0:(used/cap)*100;
    const card=document.createElement("div");card.className="table-card";
    if(used===cap){card.classList.add("full");if(!prevFullSet.has(t.id)){card.classList.add("flash-full");setTimeout(()=>card.classList.remove("flash-full"),2600);}}
    else if(used===cap-1){card.classList.add("nearly-full");}
    const peopleHtml=t.bookings.length?`<ul class="people-list">${t.bookings.map(p=>{const tag=dietaryTagFor(p.name);const cls=tag==="Intollerante"?"tag-intollerante":tag==="Vegetariana"?"tag-vegetariano":"";return `<li class="${cls}">${p.name} (${p.office})</li>`;}).join("")}</ul>`:`<div class="people-empty">Nessuno ancora.</div>`;
    card.innerHTML=`<div class="table-title">Tavolo ${t.id}</div><div class="table-info">${used} / ${cap} posti</div><div class="mini-progress"><div style="width:${perc}%;"></div></div>${peopleHtml}<button class="minus-btn" data-table-id="${t.id}" ${used===0?"disabled":""}>-1 posto</button>`;
    tablesGrid.appendChild(card);
  });
  prevFullSet=nowFullSet;
}

db.collection("bookings").orderBy("createdAt","asc").onSnapshot(snapshot=>{rebuildTablesFromSnapshot(snapshot);renderDashboard();});

tablesGrid.addEventListener("click",(e)=>{
  if(!e.target.classList.contains("minus-btn"))return;
  const id=parseInt(e.target.getAttribute("data-table-id"),10);
  const table=tables.find(t=>t.id===id); if(!table)return;
  if(table.bookings.length>0){const lastBooking=table.bookings[table.bookings.length-1]; if(lastBooking&&lastBooking.id){db.collection("bookings").doc(lastBooking.id).delete().catch(console.error);}}
});

function spinNumber(durationMs=1400,tickMs=65){return new Promise(resolve=>{const start=performance.now();const interval=setInterval(()=>{const r=1+Math.floor(Math.random()*TABLE_COUNT);const existing=result.querySelector(".table-number");if(existing){existing.textContent=r;}else{result.innerHTML=`<span class='table-label'>Il tuo tavolo è il</span><span class='table-number'>${r}</span><div class='motto'>Una sera, una squadra, una famiglia</div>`;}if(performance.now()-start>=durationMs){clearInterval(interval);resolve();}},tickMs);});}

assignBtn.onclick=async()=>{
  if(assignBtn.disabled)return;
  if(assignmentsFrozen){result.textContent="Assegnazioni momentaneamente sospese. Attendi lo staff.";return;}
  const name=nameInput.value.trim(),office=officeInput.value.trim();
  if(!name||!office){result.textContent="Inserisci Nome e Ufficio/Filiale.";return;}
  if(allFull()){result.textContent=`Tutti i tavoli sono pieni (${TOTAL_SEATS} posti).`;return;}
  const norm=normalizeNameTokens(name);
  const already=tables.some(t=>t.bookings.some(b=>normalizeNameTokens(b.name)===norm));
  if(already){const ok=confirm("Questo nome risulta già assegnato a un tavolo. Vuoi continuare comunque?");if(!ok)return;}
  assignBtn.disabled=true;
  try{
    result.innerHTML=`<span class='welcome'><strong>${name}</strong> (${office})</span><span class='table-label'>Estrazione in corso…</span><span class='table-number'>—</span><div class='motto'>Una sera, una squadra, una famiglia</div>`;
    await spinNumber(1400,65);
    let available=tables.filter(t=>t.bookings.length<t.capacity);
    if(lastAssignedTable!==null){const filtered=available.filter(t=>t.id!==lastAssignedTable);if(filtered.length>0)available=filtered;}
    const chosen=available[Math.floor(Math.random()*available.length)];
    await db.collection("bookings").add({name,office,table:chosen.id,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
    const tag=dietaryTagFor(name);
    const badge=tag==="Intollerante"?`<div style="margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;background:#c62828;color:white;font-size:12px;font-weight:bold;">INTOLLERANTE</div>`:tag==="Vegetariana"?`<div style="margin-top:8px;display:inline-block;padding:6px 10px;border-radius:999px;background:#ffeb3b;color:#111;font-size:12px;font-weight:bold;">VEGETARIANA</div>`:"";
    result.innerHTML=`<span class='welcome'><strong>${name}</strong> (${office})</span><span class='table-label'>Il tuo tavolo è il</span><span class='table-number'>${chosen.id}</span><div class='motto'>Una sera, una squadra, una famiglia</div>${badge}`;
    playBell();launchSnow();
    nameInput.value="";officeInput.value="";nameInput.focus();
  }catch(err){console.error(err);result.textContent="Si è verificato un errore, riprova tra qualche secondo.";}
  finally{assignBtn.disabled=false;}
};

resetBtn.addEventListener("click",async()=>{
  const first=confirm("ATTENZIONE: vuoi avviare la procedura di azzeramento tavoli?"); if(!first)return;
  const second=confirm("Confermi definitivamente? Partirà un countdown di 5 secondi."); if(!second)return;
  let sec=5;const original=resetBtn.textContent;resetBtn.disabled=true;resetBtn.textContent=`Reset tra ${sec}s…`;
  const timer=setInterval(()=>{sec--;if(sec<=0)clearInterval(timer);else resetBtn.textContent=`Reset tra ${sec}s…`;},1000);
  await new Promise(r=>setTimeout(r,5000));
  try{
    const snap=await db.collection("bookings").get();
    if(snap.empty){result.textContent="";alert("Nessuna prenotazione da azzerare.");return;}
    const deletions=[];snap.forEach(doc=>deletions.push(db.collection("bookings").doc(doc.id).delete()));
    await Promise.all(deletions);
    lastAssignedTable=null;result.textContent="";alert("Tavoli azzerati correttamente!");
  }catch(err){console.error("Errore reset:",err);alert("Errore nell'azzeramento dei tavoli. Riprova.");}
  finally{resetBtn.disabled=false;resetBtn.textContent=original;}
});

freezeBtn.addEventListener("click",()=>{assignmentsFrozen=!assignmentsFrozen;setFreezeUI();});
setFreezeUI();

fullscreenBtn.addEventListener("click",async()=>{
  try{
    if(!document.fullscreenElement){await document.documentElement.requestFullscreen();fullscreenBtn.textContent="Esci full screen";}
    else{await document.exitFullscreen();fullscreenBtn.textContent="Full screen";}
  }catch(e){alert("Full screen non disponibile su questo dispositivo/browser.");}
});

document.getElementById("showAdminBtn").addEventListener("click",()=>{
  const code=prompt("Codice organizzatore:");
  if(code==="1109"){
    const hidden=dashboardEl.style.display==="none"||dashboardEl.style.display==="";
    if(hidden){dashboardEl.style.display="block";bookingSection.style.display="none";}
    else{dashboardEl.style.display="none";bookingSection.style.display="block";}
  }else if(code!==null){alert("Codice errato");}
});
</script>
</body>
</html>
