<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Evento BCC - Realtime</title>

<style>
:root{
  /* Tema ispirato alla grafica allegata (verde profondo + oro) */
  --bg-green-1:#0b3f2f;
  --bg-green-2:#0a4a33;
  --bg-green-3:#073626;

  --bcc-blue:#004f71;
  --bcc-blue-2:#0a6b93;
  --bcc-green:#0aa35a;
  --bcc-gold:#C9A227;
  --bcc-gold-2:#e8c86a;
  --danger:#b22222;

  --card:#0f2f24; /* usato per dettagli */
}

body{
  font-family: Arial, sans-serif;
  /* Fondo verde profondo, con “sparkle” oro tipo cartolina */
  background:
    radial-gradient( circle at 20% 18%, rgba(201,162,39,.18), rgba(0,0,0,0) 42%),
    radial-gradient( circle at 80% 22%, rgba(201,162,39,.14), rgba(0,0,0,0) 46%),
    radial-gradient( circle at 50% 75%, rgba(201,162,39,.10), rgba(0,0,0,0) 55%),
    linear-gradient(180deg, var(--bg-green-2), var(--bg-green-3));
  display:flex;
  justify-content:center;
  padding:40px 12px 60px;
}

/* base container */
.container{
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  padding:30px;
  border-radius:22px;
  border:3px solid rgba(201,162,39,0.95);
  box-shadow:
    0 18px 50px rgba(0,0,0,0.30),
    0 0 26px rgba(201,162,39,0.32);
  width:520px;
  max-width:95vw;
}


.container::before{
  content:"";
  position:absolute;
  inset:-2px;
  border-radius:24px;
  pointer-events:none;
  background:
    radial-gradient(circle at 18% 20%, rgba(201,162,39,.55) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 28% 28%, rgba(232,200,106,.55) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 72% 24%, rgba(201,162,39,.55) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 84% 32%, rgba(232,200,106,.55) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 62% 78%, rgba(201,162,39,.45) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 22% 78%, rgba(232,200,106,.35) 0 1px, rgba(0,0,0,0) 2px);
  opacity:.55;
  mix-blend-mode:multiply;
}
.container{
  position:relative;
  overflow:hidden;
}


/* when dashboard is shown on a horizontal screen (TV/PC) */
body.dashboard-wide .container{
  width:min(1320px, 98vw);
  padding:22px;
}

/* logo/title */
.logo{ display:block; max-width:260px; margin:0 auto 12px; }
h1{ text-align:center; color:var(--bcc-blue); margin-bottom:18px; font-size:20px; }

/* form */
.field{ margin-bottom:14px; }
label{ font-weight:600; margin-bottom:4px; display:block; }
input[type=text]{ width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; }

#assignBtn{
  width:100%;
  padding:12px;
  border:none;
  border-radius:999px;
  background:linear-gradient(90deg,var(--bcc-green),var(--bcc-blue-2));
  color:white;
  font-weight:bold;
  cursor:pointer;
}
#assignBtn:disabled{ opacity:.6; cursor:default; }

/* result */
.result{ margin-top:18px; text-align:center; font-size:18px; color:var(--bcc-blue); }
.result .welcome{ font-size:18px; display:block; }
.result .table-label{ margin-top:4px; display:block; }
.result .motto{ margin-top:10px; font-size:13px; color:#2b2b2b; opacity:.92; font-style:italic; }

.result .table-number{
  font-size:44px;
  background:linear-gradient(120deg,var(--bcc-green),var(--bcc-blue-2));
  color:white;
  padding:10px 22px;
  border-radius:999px;
  display:inline-block;
  margin-top:6px;
  position:relative;
  z-index:2;
  min-width:88px;
}
.result .table-number::before{
  content:"";
  position:absolute;
  top:-12px; left:-12px; right:-12px; bottom:-12px;
  background: radial-gradient(circle, rgba(201,162,39,0.55), rgba(201,162,39,0));
  border-radius:50%;
  filter: blur(12px);
  animation: glowPulse 2.4s infinite ease-in-out;
  z-index:-1;
}
@keyframes glowPulse{
  0%{ opacity:.35; transform:scale(.92); }
  50%{ opacity:1; transform:scale(1.15); }
  100%{ opacity:.35; transform:scale(.92); }
}

/* golden stars */
#snow-container{
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  pointer-events:none;
  z-index:999;
}
.snowflake{
  position:absolute;
  font-size:38px;
  color:var(--bcc-gold);
  text-shadow:
    0 0 12px var(--bcc-gold),
    0 0 26px var(--bcc-gold),
    0 0 40px rgba(201,162,39,0.9),
    0 0 55px rgba(201,162,39,0.9);
  animation:snowFall 10s linear forwards;
  opacity:.98;
}
@keyframes snowFall{
  0%{ transform:translateY(-150px) rotate(0deg) scale(1); opacity:1; }
  100%{ transform:translateY(130vh) rotate(360deg) scale(1.6); opacity:0; }
}

/* dashboard */
.dashboard{
  margin-top:28px;
  padding-top:18px;
  border-top:2px dashed var(--bcc-gold);
  display:none;
}
body.dashboard-wide .dashboard{
  margin-top:16px;
  padding-top:12px;
}

.dashboard-banner{
  position:relative;
  overflow:hidden;
  background:
    radial-gradient(circle at 55% 55%, rgba(232,200,106,.22), rgba(0,0,0,0) 55%),
    radial-gradient(circle at 30% 35%, rgba(201,162,39,.14), rgba(0,0,0,0) 50%),
    linear-gradient(180deg, rgba(7,54,38,.92), rgba(10,74,51,.92));
  border-radius:16px;
  padding:14px 16px;
  color:white;
  display:flex;
  flex-direction:column;
  gap:4px;
  margin-bottom:10px;
  border:1px solid rgba(201,162,39,.35);
  box-shadow:0 10px 26px rgba(0,0,0,.22);
  animation:xmasGlow 10s ease-in-out infinite;
}
.dashboard-banner::before{
  content:"";
  position:absolute;
  inset:-40px;
  background:
    radial-gradient(circle at 42% 46%, rgba(201,162,39,.55) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 46% 50%, rgba(232,200,106,.45) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 50% 54%, rgba(201,162,39,.42) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 54% 58%, rgba(232,200,106,.35) 0 1px, rgba(0,0,0,0) 2px),
    radial-gradient(circle at 58% 62%, rgba(201,162,39,.30) 0 1px, rgba(0,0,0,0) 2px);
  opacity:.7;
  filter: blur(.2px);
  pointer-events:none;
}
.dashboard-banner::after{
  content:"✦";
  position:absolute;
  top:10px; right:14px;
  color:rgba(232,200,106,.95);
  font-size:22px;
  text-shadow:0 0 12px rgba(201,162,39,.55);
  opacity:.9;
  pointer-events:none;
}
@keyframes xmasGlow{
  0%{ box-shadow:0 0 6px rgba(201,162,39,0.35); background-position:0% 0; }
  50%{ box-shadow:0 0 18px rgba(201,162,39,0.85); background-position:100% 0; }
  100%{ box-shadow:0 0 6px rgba(201,162,39,0.35); background-position:0% 0; }
}
.dashboard-banner-title{ font-weight:bold; font-size:16px; }
.dashboard-banner-sub{ font-size:13px; opacity:.95; }
.dashboard-banner-quote{ font-size:12px; font-style:italic; opacity:.9; margin-top:4px; }
.dashboard-banner-quote span{ font-style:normal; font-size:11px; opacity:.9; }

.dashboard-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  margin-bottom:10px;
}
.dashboard h2{ font-size:20px; margin:0; color:var(--bcc-blue); }

.btn-pill{
  padding:6px 10px;
  font-size:12px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  color:white;
  background:linear-gradient(90deg, rgba(10,163,90,.95), rgba(0,79,113,.95));
  box-shadow:0 6px 16px rgba(0,0,0,.18);
}
.btn-pill.secondary{ background:var(--danger); }
.btn-pill.gold{ background:linear-gradient(90deg, var(--bcc-gold), var(--bcc-gold-2)); color:#1b1b1b; }
.btn-pill:disabled{ opacity:.55; cursor:default; }

/* horizontal dashboard layout */
.dashboard-layout{ display:block; }
body.dashboard-wide .dashboard-layout{
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:12px;
  align-items:start;
}

.dashboard-summary{ font-size:14px; margin:10px 0 10px; }
.dashboard-summary span{ font-weight:bold; }

.progress-wrap{ margin:10px 0 14px; }
.progress-top{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:#333;
  margin-bottom:6px;
}
.progress-bar{
  width:100%;
  height:10px;
  border-radius:999px;
  background:#eee;
  overflow:hidden;
}
.progress-fill{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--bcc-green),var(--bcc-blue-2));
  transition:width .25s ease;
}

.admin-box{
  border:1px solid #e5e5e5;
  border-radius:12px;
  padding:10px;
  background:#fff;
}
.admin-box h3{ margin:0 0 8px; font-size:13px; color:var(--bcc-blue); }
.last5{ font-size:12px; margin:0; padding-left:16px; }
.last5 li{ margin-bottom:4px; }

.tables-grid{
  display:grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap:10px;
}
body.dashboard-wide .tables-grid{
  grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
  gap:10px;
}

.table-card{
  border:1px solid #ddd;
  border-radius:12px;
  padding:10px 10px 8px;
  font-size:14px;
  background:rgba(255,255,255,0.94);
  position:relative;
  overflow:hidden;
}
.table-card::before{
  content:"";
  position:absolute;
  top:0; left:0; right:0;
  height:4px;
  background: repeating-linear-gradient(
    90deg,
    var(--bcc-gold) 0 8px,
    #ff0000 8px 16px,
    #00b300 16px 24px
  );
  opacity:.75;
}

.table-title{ font-weight:bold; margin:6px 0 4px; color:var(--bcc-blue); }
.table-info{ margin-bottom:6px; }

.mini-progress{
  width:100%;
  height:8px;
  border-radius:999px;
  background:#eee;
  overflow:hidden;
  margin-bottom:6px;
}
.mini-progress > div{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,var(--bcc-green),var(--bcc-blue-2));
  transition:width .25s ease;
}

/* status */
.table-card.nearly-full{ border-color:#e39a2b; box-shadow:0 0 0 2px rgba(227,154,43,.15); }
.table-card.full{ border-color:var(--danger); box-shadow:0 0 0 2px rgba(178,34,34,.15); }
.table-card.flash-full{ animation: flashFull 1.2s ease-in-out 0s 2; }
@keyframes flashFull{ 0%,100%{ transform:scale(1); } 50%{ transform:scale(1.02); } }

/* people list */
.people-list{
  margin:6px 0 8px;
  padding-left:0;
  list-style:none;
  font-size:12px;
  max-height:92px;
  overflow:auto;
}
.people-list li{
  margin-bottom:4px;
  padding:8px 10px;
  border-radius:8px;
  border:1px solid rgba(0,0,0,.06);
  background:white;
}
.people-empty{ font-size:12px; color:#777; margin:6px 0 10px; }

.people-list li.tag-intollerante{ background:#c62828; color:white; border-color:rgba(255,255,255,.2); }
.people-list li.tag-vegetariano{ background:#ffeb3b; color:#111; border-color:rgba(0,0,0,.1); }

.minus-btn{
  width:100%;
  padding:6px 8px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-size:12px;
  background:#f44336;
  color:white;
}
.minus-btn:disabled{ opacity:.45; cursor:default; }

.admin-btn{
  position:fixed;
  right:10px; bottom:10px;
  padding:6px 10px;
  font-size:11px;
  border-radius:999px;
  border:none;
  background:var(--danger);
  color:white;
  opacity:.7;
  z-index:1000;
}

/* === TV READABILITY ENHANCEMENTS === */
body.dashboard-wide .people-list li{
  font-size:14.5px;
  font-weight:600;
  letter-spacing:.2px;
  box-shadow: inset 0 0 0 9999px rgba(255,255,255,0.02);
}
body.dashboard-wide .people-list li{
  text-shadow: 0 0 1px rgba(0,0,0,.35);
}
body.dashboard-wide .people-list li.tag-intollerante{
  box-shadow: 0 0 0 2px rgba(255,255,255,.15) inset;
}
body.dashboard-wide .people-list li.tag-vegetariano{
  box-shadow: 0 0 0 2px rgba(0,0,0,.15) inset;
}
body.dashboard-wide .table-title{
  font-size:16px;
}
body.dashboard-wide .table-info{
  font-size:13px;
}


/* ===== PIANTINA SALA (vista mappa) ===== */
.plan-wrap{display:none;margin-top:10px;}
.plan-header{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0 10px;}
.plan-btn{padding:6px 10px;border:none;border-radius:999px;cursor:pointer;font-size:12px;color:#fff;background:var(--bcc-blue);}
.plan-btn.active{background:var(--bcc-gold);color:#1b1b1b;}
.plan-area{
  position:relative;
  width:100%;
  border-radius:16px;
  border:1px solid rgba(201,162,39,.35);
  background: rgba(255,255,255,0.78);
  overflow:hidden;
  box-shadow:0 10px 24px rgba(0,0,0,.10);
}
/* responsive aspect ratio ~ planimetry */
.plan-area::before{content:"";display:block;padding-top:52%;}
.plan-stage{
  position:absolute; inset:0;
}
.plan-label{
  position:absolute;
  font-size:12px;
  font-weight:700;
  color:#0b3f2f;
  background:rgba(255,255,255,.85);
  border:1px solid rgba(0,0,0,.08);
  padding:4px 8px;
  border-radius:14px;
}
.plan-line{
  position:absolute;
  height:2px;
  background:rgba(0,0,0,.25);
}
.tnode{
  position:absolute;
  transform:translate(-50%,-50%);
  width:125px;
  height:125px;
  border-radius:999px;
  border:2px solid rgba(0,0,0,.25);
  background:rgba(255,255,255,.92);
  display:flex;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  gap:2px;
  cursor:pointer;
  box-shadow:0 8px 18px rgba(0,0,0,.10);
}
body.dashboard-wide .tnode{width:84px;height:84px;}
.tnode .n{font-weight:900;color:var(--bcc-blue);font-size:16px;line-height:1;}
.tnode .o{font-size:11px;color:#333;line-height:1;}
.tnode.full{border-color:var(--danger);box-shadow:0 0 0 3px rgba(178,34,34,.10), 0 10px 22px rgba(0,0,0,.12);}
.tnode.nearly{border-color:#e39a2b;box-shadow:0 0 0 3px rgba(227,154,43,.10), 0 10px 22px rgba(0,0,0,.12);}
.tnode.reserved{
  background:rgba(245,245,245,.92);
  border-style:dashed;
  cursor:default;
}
.tnode.selected{outline:4px solid rgba(201,162,39,.55); outline-offset:2px;}
.tnode small{font-size:10px;color:#555;font-weight:700;}


/* ===== PIANTINA (SOLO TAVOLI, disposizione sala) ===== */
.plan-wrap{display:block;margin-top:10px;}
/* nascondo i pulsanti vista: usiamo solo la piantina */
.plan-header{display:none !important;}

.plan-area{
  position:relative;
  width:100%;
  border-radius:16px;
  border:1px solid rgba(201,162,39,.35);
  background: rgba(255,255,255,0.78);
  overflow:hidden;
  box-shadow:0 10px 24px rgba(0,0,0,.10);
}
.plan-area::before{content:"";display:block;padding-top:54.03%;} /* leggermente più alta */
.plan-stage{position:absolute; inset:0;}

/* Unica etichetta: INGRESSO */
.plan-label.ingresso{
  position:absolute;
  left:50%;
  bottom:10px;
  transform:translateX(-50%);
  font-size:12px;
  font-weight:800;
  color:#0b3f2f;
  background:rgba(255,255,255,.90);
  border:1px solid rgba(0,0,0,.10);
  padding:4px 10px;
  border-radius:999px;
}

/* Tavolo in piantina come "card" con nomi */
.tcard{
  position:absolute;
  transform:translate(-50%,-50%);
  width:220px;
  height:220px;
  border-radius:18px;
  border:1px solid rgba(0,0,0,.18);
  background:rgba(255,255,255,.95);
  box-shadow:0 10px 22px rgba(0,0,0,.12);
  overflow:hidden;
  display:flex;
  flex-direction:column;
}
body.dashboard-wide .tcard{width:150px;height:150px;}

.tcard::before{
  content:"";
  display:block;
  height:5px;
  background:repeating-linear-gradient(90deg,var(--bcc-gold) 0 8px,#ff0000 8px 16px,#00b300 16px 24px);
  opacity:.75;
}

.tcard .top{
  padding:8px 10px 6px;
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  gap:8px;
}
.tcard .title{
  font-weight:900;
  color:var(--bcc-blue);
  font-size:16px;
}
body.dashboard-wide .tcard .title{font-size:20px;}
.tcard .cap{font-size:13px;color:#333;font-weight:900;}

.tcard.reserved{
  border:2px dashed rgba(0,0,0,.25);
  background:rgba(245,245,245,.95);
}
.tcard.reserved .cap{color:#444;}

.tcard.nearly{box-shadow:0 0 0 3px rgba(227,154,43,.12), 0 10px 22px rgba(0,0,0,.12); border-color:#e39a2b;}
.tcard.full{box-shadow:0 0 0 3px rgba(178,34,34,.12), 0 10px 22px rgba(0,0,0,.12); border-color:var(--danger);}

.tcard .list{
  padding:8px 10px 10px;
  flex:1;
  overflow:auto;
}
.tcard .list ul{margin:0;padding:0;list-style:none;font-size:12px;}
body.dashboard-wide .tcard .list ul{font-size:13px;}
.tcard .list li{
  margin-bottom:4px;
  padding:8px 10px;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  background:#fff;
  white-space:normal;
  overflow:hidden;
  text-overflow:clip;
}
.tcard .list li.tag-intollerante{background:#c62828;color:#fff;border-color:rgba(255,255,255,.2);}
.tcard .list li.tag-vegetariano{background:#ffeb3b;color:#111;border-color:rgba(0,0,0,.1);}

.tcard .empty{
  color:#777;
  font-size:12px;
  padding:6px 8px;
}

.tcard .bottom{
  padding:6px 8px 8px;
}
.tcard .minus-btn{
  width:100%;
  padding:6px 8px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  font-size:12px;
  background:#f44336;
  color:#fff;
}
.tcard .minus-btn:disabled{opacity:.45;cursor:default;}


/* Office line a bit bigger on TV */
body.dashboard-wide .tcard .list li div:nth-child(2){
  font-size:14px !important;
}


/* Auto-scroll nomi se la lista è lunga (senza sovrapporre) */
.tcard .list{position:relative;}
.tcard .list.scrolling ul{
  position:absolute;
  left:10px; right:10px;
  animation: vscroll 10s linear infinite;
}
@keyframes vscroll{
  0%{ transform: translateY(0); }
  100%{ transform: translateY(-50%); }
}

</style>
</head>

<body>
<div id="snow-container"></div>

<div class="container">
  <img src="logo.jpg" class="logo" alt="Logo BCC Magna Grecia" />
  <h1>Benvenuto all'evento BCC Magna Grecia</h1>

  <div id="bookingSection">
    <div id="result" class="result"></div>

    <div class="field">
      <label>Nome</label>
      <input id="nameInput" type="text" />
    </div>

    <div class="field">
      <label>Ufficio / Filiale</label>
      <input id="officeInput" type="text" />
    </div>

    <button id="assignBtn">Scopri il tuo tavolo</button>
  </div>

  <audio id="bellSound" src="campane.mp3" preload="auto"></audio>

  <div class="dashboard" id="dashboard">
    <div class="dashboard-banner">
      <div class="dashboard-banner-title">Cena Aziendale – Insieme… a Natale</div>
      <div class="dashboard-banner-sub">
        L'unione è la nostra forza: ogni posto a tavola è un posto per condividere,
        crescere e sentirci parte della stessa famiglia.
      </div>
      <div class="dashboard-banner-quote">
        “Da soli possiamo fare così poco; insieme possiamo fare così tanto.”
        <span>– Helen Keller</span>
      </div>
    </div>

    <div class="dashboard-header">
      <h2>Dashboard tavoli</h2>
      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
        <button id="fullscreenBtn" class="btn-pill gold">Full screen</button>
        <button id="freezeBtn" class="btn-pill">Congela: OFF</button>
        <button id="resetBtn" class="btn-pill secondary">Azzera tavoli</button>
      </div>
    </div>

    <div class="dashboard-layout">
      <div>
        <div class="dashboard-summary">
          Posti totali: <span id="totalSeats"></span> —
          Occupati: <span id="occupiedSeats"></span> —
          Liberi: <span id="freeSeats"></span>
        </div>

        <div class="progress-wrap">
          <div class="progress-top">
            <div>Progresso evento</div>
            <div><span id="progressPct">0</span>%</div>
          </div>
          <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
        </div>

        <div class="admin-box">
          <h3>Ultimi 5 assegnati</h3>
          <ol id="last5List" class="last5"></ol>
        </div>
      </div>

      
<div>
  <div class="plan-header">
    <button id="viewGridBtn" class="plan-btn active">Vista griglia</button>
    <button id="viewPlanBtn" class="plan-btn">Vista piantina</button>
  </div>

  <div id="planWrap" class="plan-wrap">
    <div class="plan-area">
      <div id="planStage" class="plan-stage"></div>
    </div>
  </div>

  <div id="tablesGrid" class="tables-grid"></div>
</div>

    </div>
  </div>
</div>

<button id="showAdminBtn" class="admin-btn">Area organizzatori</button>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA1EWKdl7TXVXNJpxAR5Uj1e5h5vPgxtFk",
  authDomain: "evento-bcc-magna-grecia.firebaseapp.com",
  projectId: "evento-bcc-magna-grecia",
  storageBucket: "evento-bcc-magna-grecia.firebasestorage.app",
  messagingSenderId: "767111568452",
  appId: "1:767111568452:web:aa7cfd66ae1995c5273011"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// 25 tavoli in planimetria (23 assegnabili dal sistema):
// - Tavolo 12: CDA (RISERVATO, non assegnabile via random)
// - Tavolo 25: OPZIONALE/EMERGENZE (RISERVATO, non assegnabile via random)
// - Tavoli 22-23-24: 7 posti
// - Tutti gli altri tavoli assegnabili: 8 posti
const TABLE_COUNT = 25;

const RESERVED_TABLES = new Set([12, 25]);

const TABLE_CAPACITY_MAP = Object.fromEntries(
  Array.from({ length: TABLE_COUNT }, (_, i) => {
    const id = i + 1;
    let cap = 8;

    if (RESERVED_TABLES.has(id)) cap = 0; // riservati: non conteggiati, non assegnabili
    else if (id === 22 || id === 23 || id === 24) cap = 7;

    return [id, cap];
  })
);

// Totale posti SOLO sui tavoli assegnabili (esclude 12 e 25)
const TOTAL_SEATS = Object.entries(TABLE_CAPACITY_MAP)
  .filter(([k,v]) => !RESERVED_TABLES.has(parseInt(k,10)))
  .reduce((sum,[k,v]) => sum + v, 0);

function normalizeNameTokens(s){
  return (s || "")
    .toLowerCase()
    .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
    .replace(/[^a-z\s]/g," ")
    .split(/\s+/).filter(Boolean)
    .sort()
    .join(" ");
}

const dietaryRaw = [
  ["Antonella Mondillo","Intollerante"],
  ["Feo Fabrizio","Intollerante"],
  ["Giovanna Sansone","Intollerante"],
  ["Giuseppe Caggiano","Intollerante"],
  ["Giuseppe Cupolo","Intollerante"],
  ["Maria Corso","Intollerante"],
  ["Monica Oriente","Intollerante"],
  ["Propato Mario Domenico","Intollerante"],
  ["Rosalia La Palomenta","Intollerante"],
  ["Valeria Guercio","Intollerante"],
  ["Vincenzo De Stefano","Intollerante"],
  ["Marilena Longo","Vegetariana"],
  ["Teresa Comite","Vegetariana"],
  ["Andrea de Luca","Intollerante"]
];
const dietaryMap = new Map(dietaryRaw.map(([n,t]) => [normalizeNameTokens(n), t]));
function dietaryTagFor(name){ return dietaryMap.get(normalizeNameTokens(name)) || null; }
// ================== VINCOLO: AMODIO / RUOCCO MAI INSIEME ==================
const CONFLICT_A = normalizeNameTokens("Andrea Amodio");
const CONFLICT_B = normalizeNameTokens("Elvira Ruocco");

function findTableIdByNormalizedName(norm){
  for(const t of tables){
    for(const b of t.bookings){
      if(normalizeNameTokens(b.name) === norm) return t.id;
    }
  }
  return null;
}

function forbiddenTableForName(name){
  const norm = normalizeNameTokens(name);
  if(norm === CONFLICT_A){
    return findTableIdByNormalizedName(CONFLICT_B);
  }
  if(norm === CONFLICT_B){
    return findTableIdByNormalizedName(CONFLICT_A);
  }
  return null;
}

let tables = [];
let lastAssignedTable = null;
let assignmentsFrozen = false;
let prevFullSet = new Set();

const result = document.getElementById("result");
const nameInput = document.getElementById("nameInput");
const officeInput = document.getElementById("officeInput");
const bellSound = document.getElementById("bellSound");
const snowContainer = document.getElementById("snow-container");
const bookingSection = document.getElementById("bookingSection");

const totalSeatsEl = document.getElementById("totalSeats");
const occupiedSeatsEl = document.getElementById("occupiedSeats");
const freeSeatsEl = document.getElementById("freeSeats");
const tablesGrid = document.getElementById("tablesGrid");
const resetBtn = document.getElementById("resetBtn");
const dashboardEl = document.getElementById("dashboard");
const assignBtn = document.getElementById("assignBtn");

const fullscreenBtn = document.getElementById("fullscreenBtn");
const freezeBtn = document.getElementById("freezeBtn");

const progressPct = document.getElementById("progressPct");
const progressFill = document.getElementById("progressFill");
const last5List = document.getElementById("last5List");

totalSeatsEl.textContent = TOTAL_SEATS;

function playBell(){
  try{ bellSound.volume = 1; bellSound.currentTime = 0; bellSound.play(); }catch(e){}
}
function launchSnow(){
  for(let i=0;i<60;i++){
    const s = document.createElement("div");
    s.classList.add("snowflake");
    s.textContent = "✧";
    s.style.left = Math.random()*100 + "vw";
    s.style.animationDelay = (Math.random()*2.5) + "s";
    s.style.fontSize = (32 + Math.random()*18) + "px";
    snowContainer.appendChild(s);
    setTimeout(()=>s.remove(),11000);
  }
}
function setFreezeUI(){
  freezeBtn.textContent = assignmentsFrozen ? "Congela: ON" : "Congela: OFF";
  freezeBtn.style.background = assignmentsFrozen ? "#6d6d6d" : "var(--bcc-blue)";
}

function rebuildTablesFromSnapshot(snapshot){
  tables = Array.from({length:TABLE_COUNT}, (_,i)=>({
    id:i+1,
    capacity: TABLE_CAPACITY_MAP[i+1],
    bookings:[]
  }));

  snapshot.forEach(doc=>{
    const data = doc.data();
    const tableId = data.table;
    if(typeof tableId==="number" && tableId>=1 && tableId<=TABLE_COUNT){
      tables[tableId-1].bookings.push({
        id: doc.id,
        name: data.name || "",
        office: data.office || "",
        createdAt: data.createdAt || null
      });
    }
  });

  if(snapshot.docs.length>0){
    const lastDoc = snapshot.docs[snapshot.docs.length-1];
    const lastData = lastDoc.data();
    if(lastData && typeof lastData.table==="number"){
      lastAssignedTable = lastData.table;
    }
  }else{
    lastAssignedTable = null;
  }

  const lastDocs = snapshot.docs.slice(-5);
  last5List.innerHTML = "";
  lastDocs.forEach(d=>{
    const x = d.data();
    const li = document.createElement("li");
    li.textContent = `${x.name || "?"} → Tavolo ${x.table || "?"}`;
    last5List.appendChild(li);
  });
}

function allFull(){
  return tables
    .filter(t => !RESERVED_TABLES.has(t.id)) // ignora tavoli riservati
    .every(t => t.bookings.length >= t.capacity);
}

function renderDashboard(){
  const occupied = tables.reduce((sum,t)=>sum + t.bookings.length, 0);
  const free = TOTAL_SEATS - occupied;

  totalSeatsEl.textContent = TOTAL_SEATS;
  occupiedSeatsEl.textContent = occupied;
  freeSeatsEl.textContent = free;

  const pct = TOTAL_SEATS === 0 ? 0 : Math.round((occupied / TOTAL_SEATS) * 100);
  progressPct.textContent = pct;
  progressFill.style.width = pct + "%";

  tablesGrid.innerHTML = "";

  const nowFullSet = new Set(
    tables.filter(t => t.bookings.length >= t.capacity).map(t => t.id)
  );

  tables.forEach(t=>{
    const used = t.bookings.length;
    const cap = t.capacity;
    const perc = cap === 0 ? 0 : (used / cap) * 100;

    const card = document.createElement("div");
    card.className = "table-card";

    if(used === cap){
      card.classList.add("full");
      if(!prevFullSet.has(t.id)){
        card.classList.add("flash-full");
        setTimeout(()=>card.classList.remove("flash-full"), 2600);
      }
    }else if(used === cap - 1){
      card.classList.add("nearly-full");
    }

    const peopleHtml = (t.bookings.length)
      ? `<ul class="people-list">${
          t.bookings.map(p=>{
            const tag = dietaryTagFor(p.name);
            const cls = tag === "Intollerante" ? "tag-intollerante"
                    : tag === "Vegetariana" ? "tag-vegetariano"
                    : "";
            return `<li class="${cls}">${p.name} (${p.office})</li>`;
          }).join("")
        }</ul>`
      : `<div class="people-empty">Nessuno ancora.</div>`;

    if(RESERVED_TABLES.has(t.id)){
    const label = (t.id === 12) ? "CDA (Riservato)" : (t.id === 25) ? "Opzionale/EMERGENZE (Riservato)" : "Riservato";
    const peopleHtml = (t.bookings.length)
      ? `<ul class="people-list">${
          t.bookings.map(p=>{
            const tag = dietaryTagFor(p.name);
            const cls = tag === "Intollerante" ? "tag-intollerante"
                    : tag === "Vegetariana" ? "tag-vegetariano"
                    : "";
            return `<li class="${cls}">${p.name} (${p.office})</li>`;
          }).join("")
        }</ul>`
      : `<div class="people-empty">—</div>`;

    card.innerHTML = `
      <div class="table-title">Tavolo ${t.id}</div>
      <div class="table-info"><strong>${label}</strong></div>
      ${peopleHtml}
      <button class="minus-btn" data-table-id="${t.id}" disabled>-1 posto</button>
    `;
  }else{
    card.innerHTML = `
      <div class="table-title">Tavolo ${t.id}</div>
      <div class="table-info">${used} / ${cap} posti</div>
      <div class="mini-progress"><div style="width:${perc}%;"></div></div>
      ${peopleHtml}
      <button class="minus-btn" data-table-id="${t.id}" ${used===0 ? "disabled" : ""}>-1 posto</button>
    `;
  }
tablesGrid.appendChild(card);
  });

  prevFullSet = nowFullSet;
  // aggiorna anche vista piantina
  if(planWrap && planWrap.style.display !== 'none'){
    renderPlanNodes();
  }
}



// ================== PIANTINA POSIZIONI (percentuali) ==================
const TABLE_POS = {
  1:{x:11.74,y:21.33},
  2:{x:11.19,y:49.9},
  3:{x:30.54,y:10.77},
  4:{x:21.36,y:26.29},
  5:{x:21.36,y:43.48},
  6:{x:21.14,y:59.01},
  7:{x:39.71,y:10.77},
  8:{x:35.23,y:33.75},
  9:{x:30.54,y:43.69},
  10:{x:39.15,y:55.9},
  11:{x:30.2,y:75.98},
  13:{x:46.87,y:29.81},
  14:{x:39.71,y:77.64},
  15:{x:71.92,y:26.09},
  16:{x:72.26,y:43.48},
  17:{x:72.15,y:60.46},
  18:{x:83.78,y:23.6},
  19:{x:83.33,y:38.3},
  20:{x:83.45,y:50.72},
  21:{x:83.56,y:66.25},
  22:{x:93.85,y:24.02},
  23:{x:88.7,y:45.34},
  24:{x:88.7,y:61.28},
  25:{x:93.85,y:66.25},
  12:{x:46.98,y:32.09,shape:"rect"}
};

const planWrap = document.getElementById("planWrap");
const planStage = document.getElementById("planStage");
const viewGridBtn = document.getElementById("viewGridBtn");
const viewPlanBtn = document.getElementById("viewPlanBtn");

let selectedTableId = null;

function setView(mode){
  // Piantina unica (solo tavoli)
  if(planWrap) planWrap.style.display = "block";
  if(tablesGrid) tablesGrid.style.display = "none";
  if(viewGridBtn) viewGridBtn.classList.remove("active");
  if(viewPlanBtn) viewPlanBtn.classList.add("active");
}
setView("plan");

viewGridBtn?.addEventListener("click", ()=>setView("grid"));
viewPlanBtn?.addEventListener("click", ()=>setView("plan"));

/* Render static labels in plan */
function renderPlanLabels(){
  if(!planStage) return;
  // clear stage (we rebuild every time)
  planStage.innerHTML = "";

  const ingresso = document.createElement("div");
  ingresso.className = "plan-label ingresso";
  ingresso.textContent = "INGRESSO";
  planStage.appendChild(ingresso);
}

function nodeClassForTable(t){
  if(RESERVED_TABLES.has(t.id)) return "tnode reserved";
  if(t.bookings.length >= t.capacity) return "tnode full";
  if(t.bookings.length === t.capacity - 1) return "tnode nearly";
  return "tnode";
}

function renderPlanNodes(){
  if(!planStage) return;

  renderPlanLabels();

  tables.forEach(t=>{
    const pos = TABLE_POS[t.id];
    if(!pos) return;

    const used = t.bookings.length;
    const cap = t.capacity;

    const card = document.createElement("div");
    card.className = "tcard";

    if(RESERVED_TABLES.has(t.id)){
      card.classList.add("reserved");
    }else if(used >= cap){
      card.classList.add("full");
    }else if(used === cap - 1){
      card.classList.add("nearly");
    }

    card.style.left = pos.x + "%";
    card.style.top  = pos.y + "%";

    const label = (t.id === 12) ? "CDA" : (t.id === 25) ? "EMERGENZE" : "";

    const capText = RESERVED_TABLES.has(t.id)
      ? (label ? label : "RISERVATO")
      : `${used}/${cap}`;

    const hasMany = t.bookings.length > 6; // quando pieno/affollato -> scroll
    const listClass = hasMany ? "list scrolling" : "list";

    const listHtml = (t.bookings.length)
      ? `<ul>${
          // duplica la lista se scrolling per continuità
          (hasMany ? t.bookings.concat(t.bookings) : t.bookings).map(p=>{
            const tag = dietaryTagFor(p.name);
            const cls = tag === "Intollerante" ? "tag-intollerante"
                    : tag === "Vegetariana" ? "tag-vegetariano"
                    : "";
            return `<li class="${cls}" title="${p.name} (${p.office})"><div style="font-weight:900;">${p.name}</div><div style="font-size:11px; opacity:.85; margin-top:2px;">${p.office}</div></li>`;
          }).join("")
        }</ul>`
      : `<div class="empty">Nessuno ancora.</div>`;

    card.innerHTML = `
      <div class="top">
        <div class="title">Tavolo ${t.id}</div>
        <div class="cap">${capText}</div>
      </div>
      <div class="${listClass}">${listHtml}</div>
    `;

    // per i tavoli riservati non serve click; per gli altri lasciamo click per eventuali future funzioni
    planStage.appendChild(card);
  });
}

db.collection("bookings")
  .orderBy("createdAt","asc")
  .onSnapshot(snapshot=>{
    rebuildTablesFromSnapshot(snapshot);
    renderDashboard();
    // prepara anche la piantina
    renderPlanNodes();
  });

tablesGrid.addEventListener("click",(e)=>{
  if(!e.target.classList.contains("minus-btn")) return;
  const id = parseInt(e.target.getAttribute("data-table-id"),10);
  const table = tables.find(t=>t.id===id);
  if(!table) return;

  if(table.bookings.length>0){
    const lastBooking = table.bookings[table.bookings.length-1];
    if(lastBooking && lastBooking.id){
      db.collection("bookings").doc(lastBooking.id).delete().catch(console.error);
    }
  }

});

function spinNumber(durationMs=1400, tickMs=65){
  return new Promise(resolve=>{
    const start = performance.now();
    const interval = setInterval(()=>{
      const r = 1 + Math.floor(Math.random()*TABLE_COUNT);
      const existing = result.querySelector(".table-number");
      if(existing){
        existing.textContent = r;
      }else{
        result.innerHTML =
          `<span class='table-label'>Il tuo tavolo è il</span>
           <span class='table-number'>${r}</span>
           <div class='motto'>Una sera, una squadra, una famiglia</div>`;
      }
      if(performance.now() - start >= durationMs){
        clearInterval(interval);
        resolve();
      }
    }, tickMs);
  });
}

assignBtn.onclick = async ()=>{
  if(assignBtn.disabled) return;

  if(assignmentsFrozen){
    result.textContent = "Assegnazioni momentaneamente sospese. Attendi lo staff.";
    return;
  }

  const name = nameInput.value.trim();
  const office = officeInput.value.trim();

  if(!name || !office){
    result.textContent = "Inserisci Nome e Ufficio/Filiale.";
    return;
  }

  if(allFull()){
    result.textContent = `Tutti i tavoli sono pieni (${TOTAL_SEATS} posti).`;
    return;
  }

  const norm = normalizeNameTokens(name);
  const already = tables.some(t => t.bookings.some(b => normalizeNameTokens(b.name) === norm));
  if(already){
    const ok = confirm("Questo nome risulta già assegnato a un tavolo. Vuoi continuare comunque?");
    if(!ok) return;
  }

  assignBtn.disabled = true;

  try{
    result.innerHTML =
      `<span class='welcome'><strong>${name}</strong> (${office})</span>
       <span class='table-label'>Estrazione in corso…</span>
       <span class='table-number'>—</span>
       <div class='motto'>Una sera, una squadra, una famiglia</div>`;

    await spinNumber(1400, 65);

    let available = tables.filter(t => !RESERVED_TABLES.has(t.id) && t.bookings.length < t.capacity);

    if(lastAssignedTable !== null){
      const filtered = available.filter(t => t.id !== lastAssignedTable);
      if(filtered.length > 0) available = filtered;
    }

    
    // vincolo Amodio/Ruocco (mai insieme)
    const forbidden = forbiddenTableForName(name);
    if(forbidden !== null){
      available = available.filter(t => t.id !== forbidden);
    }
const chosen = available[Math.floor(Math.random()*available.length)];

    await db.collection("bookings").add({
      name,
      office,
      table: chosen.id,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    const tag = dietaryTagFor(name);
    const badge =
      tag === "Intollerante"
        ? `<div style="margin-top:8px; display:inline-block; padding:6px 10px; border-radius:999px; background:#c62828; color:white; font-size:12px; font-weight:bold;">INTOLLERANTE</div>`
        : tag === "Vegetariana"
          ? `<div style="margin-top:8px; display:inline-block; padding:6px 10px; border-radius:999px; background:#ffeb3b; color:#111; font-size:12px; font-weight:bold;">VEGETARIANA</div>`
          : "";

    result.innerHTML =
      `<span class='welcome'><strong>${name}</strong> (${office})</span>
       <span class='table-label'>Il tuo tavolo è il</span>
       <span class='table-number'>${chosen.id}</span>
       <div class='motto'>Una sera, una squadra, una famiglia</div>
       ${badge}`;

    playBell();
    launchSnow();

    nameInput.value = "";
    officeInput.value = "";
    nameInput.focus();

  }catch(err){
    console.error(err);
    result.textContent = "Si è verificato un errore, riprova tra qualche secondo.";
  }finally{
    assignBtn.disabled = false;
  }
};

resetBtn.addEventListener("click", async ()=>{
  const first = confirm("ATTENZIONE: vuoi avviare la procedura di azzeramento tavoli?");
  if(!first) return;

  const second = confirm("Confermi definitivamente? Partirà un countdown di 5 secondi.");
  if(!second) return;

  let sec = 5;
  const original = resetBtn.textContent;
  resetBtn.disabled = true;
  resetBtn.textContent = `Reset tra ${sec}s…`;

  const timer = setInterval(()=>{
    sec--;
    if(sec <= 0){
      clearInterval(timer);
    }else{
      resetBtn.textContent = `Reset tra ${sec}s…`;
    }
  }, 1000);

  await new Promise(r=>setTimeout(r, 5000));

  try{
    const snap = await db.collection("bookings").get();

    if(snap.empty){
      lastAssignedTable = null;
      result.textContent = "";
      alert("Nessuna prenotazione da azzerare.");
      return;
    }

    const deletions = [];
    snap.forEach(doc=>{
      deletions.push(db.collection("bookings").doc(doc.id).delete());
    });
    await Promise.all(deletions);

    lastAssignedTable = null;
    result.textContent = "";
    alert("Tavoli azzerati correttamente!");
  }catch(err){
    console.error("Errore reset:", err);
    alert("Errore nell'azzeramento dei tavoli. Riprova.");
  }finally{
    resetBtn.disabled = false;
    resetBtn.textContent = original;
  }
});

freezeBtn.addEventListener("click", ()=>{
  assignmentsFrozen = !assignmentsFrozen;
  setFreezeUI();
});
setFreezeUI();

fullscreenBtn.addEventListener("click", async ()=>{
  try{
    if(!document.fullscreenElement){
      await document.documentElement.requestFullscreen();
      fullscreenBtn.textContent = "Esci full screen";
    }else{
      await document.exitFullscreen();
      fullscreenBtn.textContent = "Full screen";
    }
  }catch(e){
    alert("Full screen non disponibile su questo dispositivo/browser.");
  }
});

document.getElementById("showAdminBtn").addEventListener("click", ()=>{
  const code = prompt("Codice organizzatore:");
  if(code === "1109"){
    const hidden = dashboardEl.style.display === "none" || dashboardEl.style.display === "";
    if(hidden){
      dashboardEl.style.display = "block";
      bookingSection.style.display = "none";
      document.body.classList.add("dashboard-wide"); // widescreen layout
      // mostra solo piantina
      if(planWrap) planWrap.style.display = "block";
      if(tablesGrid) tablesGrid.style.display = "none";

    }else{
      dashboardEl.style.display = "none";
      bookingSection.style.display = "block";
      document.body.classList.remove("dashboard-wide");
    }
  }else if(code !== null){
    alert("Codice errato");
  }
});
</script>
</body>
</html>
